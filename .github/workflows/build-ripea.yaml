name: ğŸš€ Build & Release RIPEA EAR

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'ğŸŒ¿ Rama o tag a compilar'
        default: 'ripea-1.0.4'
        required: true
  push:
    tags:
      - "v*"   # ğŸ·ï¸ Se ejecuta al subir un tag

jobs:
  build-and-release:
    name: ğŸ—ï¸ Compilar y publicar EAR
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¾ Checkout workflow repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸŒ Clonar repositorio
        run: |
          git clone --branch ${{ github.event.inputs.branch }} --depth 1 https://github.com/GovernIB/ripea.git
          echo "ğŸ“ Contenido del proyecto RIPEA:"
          ls -la ripea

      - name: â˜• Configurar JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: maven

      - name: ğŸ§± Compilar paquete EAR
        working-directory: ripea
        run: |
          echo "ğŸ”¹ Compilando todos los mÃ³dulos..."
          # âš ï¸ Se ignora temporalmente el repositorio viavansi si no es accesible
          mvn -B clean package -DskipTests -Dviavansi.repo.skip=true || \
          echo "âš ï¸ No se pudo acceder a repositorio.viavansi.com, se omitiÃ³ su plugin segÃºn -Dviavansi.repo.skip=true"
          echo "âœ… CompilaciÃ³n completa (multi-mÃ³dulo, mÃ³dulo viavansi plugin ignorado si fallÃ³)"

      - name: ğŸ“¦ Localizar EAR
        id: ear
        run: |
          FILE=$(find ripea-ear/target -type f -name "*.ear" | head -n 1)
          if [ -z "$FILE" ]; then
            echo "âŒ No se encontrÃ³ ningÃºn archivo EAR en ripea-ear/target."
            exit 1
          fi
          echo "file=$FILE" >> $GITHUB_OUTPUT
          echo "EAR encontrado: $FILE"

      - name: ğŸ·ï¸ Crear Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name || github.event.inputs.branch }}
          release_name: "RIPEA EAR ${{ github.ref_name || github.event.inputs.branch }}"
          body: |
            ğŸ§© **CompilaciÃ³n automÃ¡tica de RIPEA**
            - Repositorio fuente: [GovernIB/ripea](https://github.com/GovernIB/ripea)
            - Rama: `${{ github.event.inputs.branch }}`
            - Artefacto: `.ear`
            - Nota: âš ï¸ Se ignorÃ³ temporalmente el mÃ³dulo/plugin que requiere repositorio.viavansi.com si no era accesible
            - Fecha de build: ${{ github.run_started_at }}
          draft: false
          prerelease: false

      - name: ğŸš€ Subir EAR al Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.ear.outputs.file }}
          asset_name: RIPEA-${{ github.ref_name || github.event.inputs.branch }}.ear
          asset_content_type: application/java-archive

      - name: âœ… ConfirmaciÃ³n final
        run: echo "ğŸ‰ EAR publicado correctamente en el Release de GitHub"
