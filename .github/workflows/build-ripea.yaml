name: ğŸš€ Build & Release RIPEA EAR

on:
  workflow_dispatch:
    inputs:
      repo:
        description: 'ğŸ“¦ Repositorio'
        default: 'GovernIB/ripea'
        required: true
      branch:
        description: 'ğŸŒ¿ Rama o tag a compilar'
        default: 'ripea-1.0'
        required: true

  push:
    tags:
      - "v*"   # ğŸ·ï¸ Se ejecuta al subir un tag

jobs:
  build-and-release:
    name: ğŸ—ï¸ Compilar y publicar EAR
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¾ Checkout workflow repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸŒ Clonar repositorio
        run: |
          git clone --branch ${{ github.event.inputs.branch }} --depth 1 https://github.com/${{ github.event.inputs.repo }}

      - name: â˜• Configurar JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: maven

      - name: ğŸ§± Compilar EAR
        working-directory: ripea
        run: |
          echo "âš ï¸ Intentando compilar ${{ github.event.inputs.repo }}, sin el plugin viavansi"
          mvn -B clean install -pl '!ripea-plugin',ripea-service,ripea-service-intf,ripea-back,ripea-api-interna,ripea-ejb,ripea-ear -am -Dviavansi.repo.skip=true || echo "âš ï¸ Se omite el plugin Viavansi al no ser accesible"
          echo "âœ… CompilaciÃ³n completa (multi-mÃ³dulo, mÃ³dulo viavansi plugin ignorado si fallÃ³)"

      - name: ğŸ“¦ Localizar EAR
        id: ear
        run: |
          FILE=$(find ripea-ear/target -type f -name "*.ear" | head -n 1)
          if [ -z "$FILE" ]; then
            echo "âŒ No se encontrÃ³ ningÃºn archivo EAR en ripea-ear/target."
            exit 1
          fi
          echo "file=$FILE" >> $GITHUB_OUTPUT
          echo "EAR encontrado: $FILE"

      - name: ğŸ·ï¸ Crear Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name || github.event.inputs.branch }}
          release_name: "RIPEA EAR ${{ github.ref_name || github.event.inputs.branch }}"
          body: |
            ğŸ§© **CompilaciÃ³n automÃ¡tica de RIPEA**
            - Repositorio fuente: [${{ github.event.inputs.repo }}](https://github.com/${{ github.event.inputs.repo }})
            - Rama: `${{ github.event.inputs.branch }}`
            - Artefacto: `.ear`
            - Nota: âš ï¸ Se ignorÃ³ temporalmente el mÃ³dulo/plugin que requiere `repositorio.viavansi.com` si no era accesible.
            - Fecha de build: ${{ github.run_started_at }}
          draft: false
          prerelease: false

      - name: ğŸš€ Subir EAR al Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.ear.outputs.file }}
          asset_name: RIPEA-${{ github.ref_name || github.event.inputs.branch }}.ear
          asset_content_type: application/java-archive

      - name: âœ… EAR publicado
        run: echo "ğŸ‰ EAR publicado correctamente en el Release de GitHub"
